{% extends 'text_to_speech_app/user_template/base_template.html' %}
{% load custom_filters %}
{% block main_content %}
<!-- Main content -->
<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="">
          <div class="card-header">
            <h3 class="card-title">Recently Uploaded</h3>
            <div class="card-tools">
              <div class="input-group input-group-sm" style="width: 150px;">
                <input type="text" id="table_search" name="table_search" class="form-control float-right" placeholder="Search">
                <div class="input-group-append">
                  <button type="submit" class="btn btn-default"><i class="fas fa-search"></i></button>
                </div>
              </div>
            </div>
          </div> 
          <!-- /.card-header -->
          <div class="card-body table-responsive p-0">
            <table class="table text-nowrap">
              <tbody id="pdf-table-body">
                {% if messages %}
                  {% for message in messages %}
                    {% if message.tags == 'error' %}
                      <div class="alert alert-danger" style="margin-top:10px">{{ message }}</div>
                    {% endif %}
                    {% if message.tags == 'success' %}
                      <div class="alert alert-success" style="margin-top:10px">{{ message }}</div>
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% for pdf in pdfs %}
                  <tr>
                    <td>{{ pdf.file|basename }}</td>
                    <td>
                      <a href="#" class="reconvert-link" data-url="{% url 'reconvert_pdf' pdf.id %}">
                        <i class="fas fa-redo"></i>
                      </a>
                      <i class="fas fa-spinner fa-spin d-none"></i>
                    </td>
                    <td><a href="{% url 'delete_pdf' pdf.id %}"><i class="fas fa-trash-alt"></i></a></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <!-- /.card-body -->
        </div>
        <!-- /.card -->
      </div>
    </div>
  </div>
</section>
<!-- /.content -->

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById('table_search');

    searchInput.addEventListener('input', function() {
      const query = this.value;

      fetch(`{% url 'search_pdfs' %}?q=${query}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        const pdfTableBody = document.getElementById('pdf-table-body');
        pdfTableBody.innerHTML = '';

        data.pdfs.forEach(pdf => {
          const row = document.createElement('tr');

          const fileNameCell = document.createElement('td');
          fileNameCell.textContent = pdf.file;

          const reconvertCell = document.createElement('td');
          const reconvertLink = document.createElement('a');
          reconvertLink.href = '#';
          reconvertLink.classList.add('reconvert-link');
          reconvertLink.dataset.url = `{% url 'reconvert_pdf' 0 %}`.replace('0', pdf.id);
          reconvertLink.innerHTML = '<i class="fas fa-redo"></i>';
          const spinner = document.createElement('i');
          spinner.classList.add('fas', 'fa-spinner', 'fa-spin', 'd-none');
          reconvertCell.appendChild(reconvertLink);
          reconvertCell.appendChild(spinner);

          const deleteCell = document.createElement('td');
          const deleteLink = document.createElement('a');
          deleteLink.href = `{% url 'delete_pdf' 0 %}`.replace('0', pdf.id);
          deleteLink.innerHTML = '<i class="fas fa-trash-alt"></i>';
          deleteCell.appendChild(deleteLink);

          row.appendChild(fileNameCell);
          row.appendChild(reconvertCell);
          row.appendChild(deleteCell);

          pdfTableBody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });

    document.addEventListener('click', function(event) {
      if (event.target.closest('.reconvert-link')) {
        event.preventDefault();
        const link = event.target.closest('.reconvert-link');
        const spinner = link.nextElementSibling;
        link.classList.add('d-none');
        spinner.classList.remove('d-none');

        fetch(link.dataset.url, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            spinner.classList.add('d-none');
            link.classList.remove('d-none');
            alert('PDF reconverted successfully!');
            // You can add more actions here, e.g., updating the link to the new audio file
          } else {
            spinner.classList.add('d-none');
            link.classList.remove('d-none');
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          spinner.classList.add('d-none');
          link.classList.remove('d-none');
          alert('Error: ' + error.message);
        });
      }
    });
  });
</script>
{% endblock %}
